// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// TABLA 1: OC CHINA
model OCChina {
  id                 String   @id @default(cuid())
  oc                 String   @unique
  proveedor          String
  fechaOC            DateTime @map("fecha_oc")
  descripcionLote    String?  @map("descripcion_lote") @db.Text
  categoriaPrincipal String   @map("categoria_principal")

  // Campos calculados (ahora derivados de items)
  // cantidadOrdenada = suma de items.cantidadTotal
  // costoFOBTotalUSD = suma de items.subtotalUSD

  // Log铆stica y distribuci贸n de costos
  cantidadCajas Int? @map("cantidad_cajas") // N煤mero total de cajas/bultos (para distribuci贸n de gastos de flete)

  // Adjuntos (fotos y PDFs)
  adjuntos Json? // [{nombre, url, tipo, size, uploadedAt}]

  // Relaciones
  items              OCChinaItem[]
  pagosChina         PagosChina[]
  gastosLogisticos   GastoLogisticoOC[]
  inventarioRecibido InventarioRecibido[]

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([proveedor])
  @@index([fechaOC])
  @@index([categoriaPrincipal])
  @@index([deletedAt])
  @@index([cantidadCajas]) // ndice para queries de distribuci贸n de costos
  @@index([deletedAt, fechaOC]) // ndice compuesto para queries comunes: filtrar activos y ordenar por fecha
  @@index([proveedor, deletedAt]) // ndice compuesto para buscar por proveedor excluyendo eliminados
  @@map("oc_china")
}

// TABLA 1.5: ITEMS DE OC CHINA (productos individuales)
model OCChinaItem {
  id   String @id @default(cuid())
  ocId String @map("oc_id")

  // Informaci贸n del producto
  sku              String
  nombre           String // "men leather shoes", "backpack"
  material         String? @db.Text // "COW LEATHER + EVA SOLE..."
  color            String? @db.Text // "brown leather + brown lace"
  especificaciones String? @db.Text // Notas adicionales

  // Tallas y cantidades
  tallaDistribucion Json? // {"38": 10, "39": 20, "40": 20}
  cantidadTotal     Int // Suma de todas las tallas

  // Precios
  precioUnitarioUSD Decimal @db.Decimal(10, 4)
  subtotalUSD       Decimal @db.Decimal(12, 2)

  // Medidas f铆sicas (para distribuci贸n de costos)
  pesoUnitarioKg     Decimal? @map("peso_unitario_kg") @db.Decimal(10, 4) // Peso por unidad en kg
  volumenUnitarioCBM Decimal? @map("volumen_unitario_cbm") @db.Decimal(10, 6) // Volumen por unidad en m鲁
  pesoTotalKg        Decimal? @map("peso_total_kg") @db.Decimal(12, 4) // pesoUnitarioKg * cantidadTotal
  volumenTotalCBM    Decimal? @map("volumen_total_cbm") @db.Decimal(12, 6) // volumenUnitarioCBM * cantidadTotal

  // Relaciones
  ocChina            OCChina              @relation(fields: [ocId], references: [id], onDelete: Cascade)
  inventarioRecibido InventarioRecibido[]

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([ocId])
  @@index([sku])
  @@index([deletedAt])
  @@map("oc_china_items")
}

// TABLA 2: PAGOS CHINA
model PagosChina {
  id               String   @id @default(cuid())
  idPago           String   @unique @map("id_pago")
  ocId             String   @map("oc_id")
  fechaPago        DateTime @map("fecha_pago")
  tipoPago         String   @map("tipo_pago")
  metodoPago       String   @map("metodo_pago")
  moneda           String
  montoOriginal    Decimal  @map("monto_original") @db.Decimal(12, 2)
  tasaCambio       Decimal  @default(1) @map("tasa_cambio") @db.Decimal(8, 4)
  comisionBancoUSD Decimal  @default(0) @map("comision_banco_usd") @db.Decimal(10, 2)
  montoRD          Decimal? @map("monto_rd") @db.Decimal(12, 2)
  montoRDNeto      Decimal? @map("monto_rd_neto") @db.Decimal(12, 2)

  // Adjuntos (recibos de pago)
  adjuntos Json? // [{nombre, url, tipo, size, uploadedAt}]

  // Relaciones
  ocChina OCChina @relation(fields: [ocId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([ocId])
  @@index([tipoPago])
  @@index([metodoPago])
  @@index([fechaPago])
  @@index([moneda])
  @@index([deletedAt])
  @@map("pagos_china")
}

// TABLA 3: GASTOS LOGSTICOS
model GastosLogisticos {
  id                String   @id @default(cuid())
  idGasto           String   @unique @map("id_gasto")
  fechaGasto        DateTime @map("fecha_gasto")
  tipoGasto         String   @map("tipo_gasto")
  proveedorServicio String?  @map("proveedor_servicio")
  metodoPago        String   @map("metodo_pago") // Efectivo, Transferencia, Tarjeta, Cheque
  montoRD           Decimal  @map("monto_rd") @db.Decimal(12, 2)
  notas             String?  @db.Text

  // Adjuntos (facturas, recibos, documentos)
  adjuntos Json? // [{nombre, url, tipo, size, uploadedAt}]

  // Relaciones many-to-many con OCs
  ordenesCompra GastoLogisticoOC[]

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([tipoGasto])
  @@index([metodoPago])
  @@index([fechaGasto])
  @@index([deletedAt])
  @@map("gastos_logisticos")
}

// TABLA 3.5: RELACIN MANY-TO-MANY ENTRE GASTOS Y OCS
// Un gasto puede estar asociado a m煤ltiples 贸rdenes de compra
// (Ej: un contenedor con productos de varias OCs)
model GastoLogisticoOC {
  id      String @id @default(cuid())
  gastoId String @map("gasto_id")
  ocId    String @map("oc_id")

  // Relaciones
  gasto   GastosLogisticos @relation(fields: [gastoId], references: [id], onDelete: Cascade)
  ocChina OCChina          @relation(fields: [ocId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([gastoId, ocId])
  @@index([gastoId])
  @@index([ocId])
  @@map("gastos_logisticos_oc")
}

// TABLA 4: INVENTARIO RECIBIDO
model InventarioRecibido {
  id                    String   @id @default(cuid())
  idRecepcion           String   @unique @map("id_recepcion")
  ocId                  String   @map("oc_id")
  itemId                String?  @map("item_id") // Nuevo: vincular a producto espec铆fico
  fechaLlegada          DateTime @map("fecha_llegada")
  bodegaInicial         String   @map("bodega_inicial")
  cantidadRecibida      Int      @map("cantidad_recibida")
  costoUnitarioFinalRD  Decimal? @map("costo_unitario_final_rd") @db.Decimal(12, 2)
  costoTotalRecepcionRD Decimal? @map("costo_total_recepcion_rd") @db.Decimal(12, 2)
  notas                 String?  @db.Text

  // Relaciones
  ocChina OCChina      @relation(fields: [ocId], references: [id], onDelete: Cascade)
  item    OCChinaItem? @relation(fields: [itemId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([ocId])
  @@index([itemId])
  @@index([bodegaInicial])
  @@index([fechaLlegada])
  @@index([deletedAt])
  @@map("inventario_recibido")
}

// TABLA 4.5: PRODUCTOS - Cat谩logo consolidado con pricing
model Producto {
  id     String @id @default(cuid())
  sku    String @unique
  nombre String

  // Pricing
  precioVenta Decimal? @map("precio_venta") @db.Decimal(10, 2)

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([sku])
  @@index([nombre])
  @@index([deletedAt])
  @@map("productos")
}

// TABLA 5: CONFIGURACIONES DEL SISTEMA
model Configuracion {
  id        String  @id @default(cuid())
  categoria String // "categorias", "tiposPago", "metodosPago", "bodegas", "tiposGasto"
  valor     String
  orden     Int     @default(0)
  activo    Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([categoria, valor])
  @@index([categoria])
  @@index([activo])
  @@map("configuracion")
}

// TABLA 6: USUARIOS DEL SISTEMA
model User {
  id           String  @id @default(cuid())
  email        String  @unique
  name         String
  lastName     String? @map("last_name")
  password     String // Hashed con bcrypt
  role         String  @default("limitado") // "limitado" | "admin" | "superadmin"
  activo       Boolean @default(true)
  profilePhoto String? @map("profile_photo") // URL de la foto de perfil

  // Relaciones
  auditLogs               AuditLog[]
  comments                Comment[]
  reactions               Reaction[]
  notificationsTriggered  Notificacion[] @relation("NotificationActor") // Notificaciones donde este usuario fue el actor

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  lastLogin DateTime? @map("last_login")

  @@index([email])
  @@index([activo])
  @@map("users")
}

// TABLA: INVITACIONES DE USUARIO
model UserInvitation {
  id        String   @id @default(cuid())
  email     String
  role      String // "limitado" | "admin" | "superadmin"
  token     String   @unique // Token seguro para el enlace de invitaci贸n
  expiresAt DateTime @map("expires_at") // Expira en 7 d铆as
  accepted  Boolean  @default(false) // true cuando el usuario completa el registro
  invitedBy String   @map("invited_by") // Email del super admin que envi贸 la invitaci贸n

  createdAt DateTime @default(now()) @map("created_at")

  @@index([token])
  @@index([email])
  @@index([expiresAt])
  @@map("user_invitations")
}

// TABLA 7: PROVEEDORES (CRM)
model Proveedor {
  id     String @id @default(cuid())
  codigo String @unique // "PROV-001"
  nombre String

  // Informaci贸n de contacto
  contactoPrincipal String? @map("contacto_principal")
  email             String?
  telefono          String?
  whatsapp          String?
  wechat            String?

  // Ubicaci贸n
  pais      String  @default("China")
  ciudad    String?
  direccion String? @db.Text

  // Informaci贸n comercial
  sitioWeb           String? @map("sitio_web")
  categoriaProductos String? @map("categoria_productos") // Zapatos, Carteras, etc.
  tiempoEntregaDias  Int?    @default(30) @map("tiempo_entrega_dias")
  monedaPreferida    String? @default("USD") @map("moneda_preferida")

  // T茅rminos comerciales
  terminosPago String?  @map("terminos_pago") @db.Text // "50% anticipo, 50% antes de env铆o"
  minimoOrden  Decimal? @map("minimo_orden") @db.Decimal(12, 2)

  // Notas y calificaci贸n
  notas        String? @db.Text
  calificacion Int?    @default(0) // 0-5 estrellas

  // Estado
  activo Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([nombre])
  @@index([activo])
  @@index([pais])
  @@map("proveedores")
}

// TABLA 8: CONFIGURACIN DE DISTRIBUCIN DE COSTOS
model ConfiguracionDistribucionCostos {
  id                 String  @id @default(cuid())
  tipoCosto          String  @map("tipo_costo") // "pagos", "gastos_flete", "gastos_aduana", "gastos_transporte_local", "comisiones"
  metodoDistribucion String  @map("metodo_distribucion") // "peso", "volumen", "valor_fob", "unidades"
  activo             Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([tipoCosto])
  @@index([tipoCosto])
  @@index([activo])
  @@map("config_distribucion_costos")
}

// TABLA 9: AUDIT LOG - Registro de cambios y acciones
model AuditLog {
  id String @id @default(cuid())

  // Qu茅 cambi贸
  entidad   String // "OCChina", "PagosChina", "GastosLogisticos", etc.
  entidadId String @map("entidad_id") // ID del registro afectado
  accion    String // "CREATE", "UPDATE", "DELETE", "RESTORE"

  // Qui茅n y cu谩ndo
  usuarioId    String? @map("usuario_id") // ID del usuario (futuro)
  usuarioEmail String? @map("usuario_email") // Email del usuario
  usuario      User?   @relation(fields: [usuarioId], references: [id], onDelete: SetNull)
  ipAddress    String? @map("ip_address") // IP del cliente
  userAgent    String? @map("user_agent") // Navegador/cliente

  // Qu茅 datos cambiaron
  cambiosAntes      Json?    @map("cambios_antes") // Estado anterior (para UPDATE/DELETE)
  cambiosDespues    Json?    @map("cambios_despues") // Estado nuevo (para CREATE/UPDATE)
  camposModificados String[] @map("campos_modificados") // ["proveedor", "fechaOC"]

  // Contexto adicional
  descripcion String? @db.Text // Descripci贸n legible del cambio
  metadata    Json? // Metadata adicional

  // Relaciones
  notificaciones Notificacion[]

  // Timestamp
  createdAt DateTime @default(now()) @map("created_at")

  @@index([entidad])
  @@index([entidadId])
  @@index([accion])
  @@index([usuarioId])
  @@index([usuarioEmail]) // ndice para buscar logs por email de usuario
  @@index([createdAt])
  @@index([entidad, entidadId]) // ndice compuesto para buscar logs de un registro espec铆fico
  @@index([entidad, createdAt]) // ndice compuesto para buscar logs por entidad ordenados por fecha
  @@map("audit_logs")
}

// TABLA 10: NOTIFICACIONES - Sistema de notificaciones en tiempo real
model Notificacion {
  id String @id @default(cuid())

  // Tipo y contenido
  tipo        String // "audit", "alert", "error", "success", "warning"
  titulo      String // T铆tulo corto de la notificaci贸n
  descripcion String? @db.Text // Descripci贸n detallada
  icono       String? // Emoji o 铆cono a mostrar

  // Relaci贸n con entidad (opcional)
  entidad   String? // "OCChina", "PagosChina", etc.
  entidadId String? @map("entidad_id") // ID del registro relacionado
  url       String? // URL a la que navegar al hacer click

  // Relaci贸n con audit log (opcional)
  auditLogId String?   @map("audit_log_id") // ID del audit log relacionado
  auditLog   AuditLog? @relation(fields: [auditLogId], references: [id])

  // Estado
  leida   Boolean   @default(false) // Si fue le铆da por el usuario
  leidaAt DateTime? @map("leida_at") // Cu谩ndo fue le铆da

  // Usuario destinatario (futuro: multi-usuario)
  usuarioId String? @map("usuario_id") // null = todos los usuarios

  // Usuario que realiz贸 la acci贸n (para mostrar foto de perfil)
  actorId String? @map("actor_id") // Usuario que dispar贸 la notificaci贸n
  actor   User?   @relation("NotificationActor", fields: [actorId], references: [id])

  // Prioridad (futuro)
  prioridad String @default("normal") // "low", "normal", "high", "urgent"

  // Expiraci贸n (futuro)
  expiresAt DateTime? @map("expires_at") // Cuando debe dejar de mostrarse

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([tipo])
  @@index([leida])
  @@index([usuarioId])
  @@index([actorId])
  @@index([createdAt])
  @@index([expiresAt]) // ndice para limpiar notificaciones expiradas
  @@index([entidad, entidadId])
  @@index([auditLogId])
  @@index([leida, createdAt]) // ndice compuesto para queries comunes
  @@index([usuarioId, leida, createdAt]) // ndice compuesto para notificaciones de usuario
  @@map("notificaciones")
}

// TABLA 11: COMENTARIOS - Sistema de comentarios en registros
model Comment {
  id String @id @default(cuid())

  // Usuario que comenta
  userId String @map("usuario_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Entidad comentada (polim贸rfico - puede ser OC, Pago, Gasto, etc.)
  entityType String @map("entity_type") // "OCChina", "PagosChina", "GastosLogisticos", "InventarioRecibido", "Producto"
  entityId   String @map("entity_id") // ID del registro comentado

  // Contenido del comentario
  content String @db.Text

  // Archivos adjuntos (array de objetos JSON)
  // Cada objeto: { url: string, name: string, type: string, size: number }
  attachments Json? @default("[]")

  // Menciones de usuarios (array de user IDs mencionados con @)
  // Ejemplo: ["user_id_1", "user_id_2"]
  mentions String[] @default([])

  // Respuestas anidadas (threads) - self-referential relation
  parentId String?   @map("parent_id") // ID del comentario padre (null = comentario ra铆z)
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentReplies") // Comentarios hijos (respuestas)

  // Relaciones
  reactions Reaction[] // Reacciones emoji del comentario

  // Edici贸n
  editedAt DateTime? @map("edited_at") // Si fue editado, cu谩ndo

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([entityType, entityId]) // ndice compuesto para buscar comentarios de una entidad espec铆fica
  @@index([entityType, entityId, createdAt]) // ndice compuesto para ordenar por fecha
  @@index([createdAt])
  @@index([parentId]) // ndice para b煤squedas de respuestas
  @@map("comments")
}

// TABLA 12: REACCIONES - Reacciones emoji en comentarios
model Reaction {
  id String @id @default(cuid())

  // Comentario reaccionado
  commentId String  @map("comment_id")
  comment   Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  // Usuario que reacciona
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Emoji de la reacci贸n
  emoji String // "", "わ", "", "", "", etc.

  // Timestamp
  createdAt DateTime @default(now()) @map("created_at")

  // Un usuario solo puede reaccionar una vez por emoji en cada comentario
  @@unique([commentId, userId, emoji])
  @@index([commentId])
  @@index([userId])
  @@index([commentId, emoji]) // ndice compuesto para contar reacciones por emoji
  @@map("reactions")
}
