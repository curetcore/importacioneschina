// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// TABLA 1: OC CHINA
model OCChina {
  id                    String   @id @default(cuid())
  oc                    String   @unique
  proveedor             String
  fechaOC               DateTime @map("fecha_oc")
  descripcionLote       String?  @map("descripcion_lote") @db.Text
  categoriaPrincipal    String   @map("categoria_principal")

  // Campos calculados (ahora derivados de items)
  // cantidadOrdenada = suma de items.cantidadTotal
  // costoFOBTotalUSD = suma de items.subtotalUSD

  // Adjuntos (fotos y PDFs)
  adjuntos              Json?    // [{nombre, url, tipo, size, uploadedAt}]

  // Relaciones
  items                 OCChinaItem[]
  pagosChina            PagosChina[]
  gastosLogisticos      GastosLogisticos[]
  inventarioRecibido    InventarioRecibido[]

  // Timestamps
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("oc_china")
  @@index([proveedor])
  @@index([fechaOC])
}

// TABLA 1.5: ITEMS DE OC CHINA (productos individuales)
model OCChinaItem {
  id                    String   @id @default(cuid())
  ocId                  String   @map("oc_id")

  // Información del producto
  sku                   String
  nombre                String               // "men leather shoes", "backpack"
  material              String?  @db.Text    // "COW LEATHER + EVA SOLE..."
  color                 String?  @db.Text    // "brown leather + brown lace"
  especificaciones      String?  @db.Text    // Notas adicionales

  // Tallas y cantidades
  tallaDistribucion     Json?                // {"38": 10, "39": 20, "40": 20}
  cantidadTotal         Int                  // Suma de todas las tallas

  // Precios
  precioUnitarioUSD     Decimal  @db.Decimal(10, 4)
  subtotalUSD           Decimal  @db.Decimal(12, 2)

  // Relaciones
  ocChina               OCChina  @relation(fields: [ocId], references: [id], onDelete: Cascade)
  inventarioRecibido    InventarioRecibido[]

  // Timestamps
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("oc_china_items")
  @@index([ocId])
  @@index([sku])
}

// TABLA 2: PAGOS CHINA
model PagosChina {
  id                    String   @id @default(cuid())
  idPago                String   @unique @map("id_pago")
  ocId                  String   @map("oc_id")
  fechaPago             DateTime @map("fecha_pago")
  tipoPago              String   @map("tipo_pago")
  metodoPago            String   @map("metodo_pago")
  moneda                String
  montoOriginal         Decimal  @map("monto_original") @db.Decimal(12, 2)
  tasaCambio            Decimal  @default(1) @map("tasa_cambio") @db.Decimal(8, 4)
  comisionBancoRD       Decimal  @default(0) @map("comision_banco_rd") @db.Decimal(10, 2)
  montoRD               Decimal? @map("monto_rd") @db.Decimal(12, 2)
  montoRDNeto           Decimal? @map("monto_rd_neto") @db.Decimal(12, 2)

  // Adjuntos (recibos de pago)
  adjuntos              Json?    // [{nombre, url, tipo, size, uploadedAt}]

  // Relaciones
  ocChina               OCChina  @relation(fields: [ocId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("pagos_china")
  @@index([ocId])
  @@index([tipoPago])
  @@index([fechaPago])
}

// TABLA 3: GASTOS LOGÍSTICOS
model GastosLogisticos {
  id                    String   @id @default(cuid())
  idGasto               String   @unique @map("id_gasto")
  ocId                  String   @map("oc_id")
  fechaGasto            DateTime @map("fecha_gasto")
  tipoGasto             String   @map("tipo_gasto")
  proveedorServicio     String?  @map("proveedor_servicio")
  metodoPago            String   @map("metodo_pago") // Efectivo, Transferencia, Tarjeta, Cheque
  montoRD               Decimal  @map("monto_rd") @db.Decimal(12, 2)
  notas                 String?  @db.Text

  // Adjuntos (facturas, recibos, documentos)
  adjuntos              Json?    // [{nombre, url, tipo, size, uploadedAt}]

  // Relaciones
  ocChina               OCChina  @relation(fields: [ocId], references: [id], onDelete: Cascade)

  // Timestamps
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("gastos_logisticos")
  @@index([ocId])
  @@index([tipoGasto])
  @@index([fechaGasto])
}

// TABLA 4: INVENTARIO RECIBIDO
model InventarioRecibido {
  id                        String   @id @default(cuid())
  idRecepcion               String   @unique @map("id_recepcion")
  ocId                      String   @map("oc_id")
  itemId                    String?  @map("item_id")  // Nuevo: vincular a producto específico
  fechaLlegada              DateTime @map("fecha_llegada")
  bodegaInicial             String   @map("bodega_inicial")
  cantidadRecibida          Int      @map("cantidad_recibida")
  costoUnitarioFinalRD      Decimal? @map("costo_unitario_final_rd") @db.Decimal(12, 2)
  costoTotalRecepcionRD     Decimal? @map("costo_total_recepcion_rd") @db.Decimal(12, 2)
  notas                     String?  @db.Text

  // Relaciones
  ocChina                   OCChina      @relation(fields: [ocId], references: [id], onDelete: Cascade)
  item                      OCChinaItem? @relation(fields: [itemId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt                 DateTime @default(now()) @map("created_at")
  updatedAt                 DateTime @updatedAt @map("updated_at")

  @@map("inventario_recibido")
  @@index([ocId])
  @@index([itemId])
  @@index([bodegaInicial])
  @@index([fechaLlegada])
}

// TABLA 5: CONFIGURACIONES DEL SISTEMA
model Configuracion {
  id                    String   @id @default(cuid())
  categoria             String   // "categorias", "tiposPago", "metodosPago", "bodegas", "tiposGasto"
  valor                 String
  orden                 Int      @default(0)
  activo                Boolean  @default(true)

  // Timestamps
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("configuracion")
  @@unique([categoria, valor])
  @@index([categoria])
  @@index([activo])
}

// TABLA 6: USUARIOS DEL SISTEMA
model User {
  id                    String   @id @default(cuid())
  email                 String   @unique
  name                  String
  password              String   // Hashed con bcrypt
  role                  String   @default("user") // "admin" | "user"
  activo                Boolean  @default(true)

  // Timestamps
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  lastLogin             DateTime? @map("last_login")

  @@map("users")
  @@index([email])
  @@index([activo])
}

// TABLA 7: PROVEEDORES (CRM)
model Proveedor {
  id                    String   @id @default(cuid())
  codigo                String   @unique  // "PROV-001"
  nombre                String

  // Información de contacto
  contactoPrincipal     String?  @map("contacto_principal")
  email                 String?
  telefono              String?
  whatsapp              String?
  wechat                String?

  // Ubicación
  pais                  String   @default("China")
  ciudad                String?
  direccion             String?  @db.Text

  // Información comercial
  sitioWeb              String?  @map("sitio_web")
  categoriaProductos    String?  @map("categoria_productos")  // Zapatos, Carteras, etc.
  tiempoEntregaDias     Int?     @default(30) @map("tiempo_entrega_dias")
  monedaPreferida       String?  @default("USD") @map("moneda_preferida")

  // Términos comerciales
  terminosPago          String?  @db.Text @map("terminos_pago")  // "50% anticipo, 50% antes de envío"
  minimoOrden           Decimal? @db.Decimal(12, 2) @map("minimo_orden")

  // Notas y calificación
  notas                 String?  @db.Text
  calificacion          Int?     @default(0)  // 0-5 estrellas

  // Estado
  activo                Boolean  @default(true)

  // Relaciones
  productos             Producto[]
  metodosPago           MetodoPago[]

  // Timestamps
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("proveedores")
  @@index([nombre])
  @@index([activo])
  @@index([pais])
}

// TABLA 8: CATÁLOGO DE PRODUCTOS
model Producto {
  id                    String   @id @default(cuid())
  sku                   String   @unique
  nombre                String

  // Proveedor
  proveedorId           String?  @map("proveedor_id")

  // Descripción
  descripcion           String?  @db.Text
  material              String?
  color                 String?
  categoria             String?

  // Precios de referencia (últimos conocidos)
  precioReferenciaUSD   Decimal? @db.Decimal(10, 4) @map("precio_referencia_usd")
  precioReferenciaCNY   Decimal? @db.Decimal(10, 4) @map("precio_referencia_cny")
  ultimaActualizacionPrecio DateTime? @map("ultima_actualizacion_precio")

  // Especificaciones técnicas
  especificaciones      String?  @db.Text
  tallasDisponibles     Json?    @map("tallas_disponibles")  // ["S", "M", "L", "XL"] o {"38": true, "39": true}

  // Imágenes y documentos
  imagenPrincipal       String?  @map("imagen_principal")  // URL
  imagenesAdicionales   Json?    @map("imagenes_adicionales")  // [url1, url2, url3]
  fichatecnica          String?  @map("ficha_tecnica")  // URL del PDF

  // Estado
  activo                Boolean  @default(true)

  // Relaciones
  proveedor             Proveedor? @relation(fields: [proveedorId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("productos")
  @@index([proveedorId])
  @@index([sku])
  @@index([nombre])
  @@index([categoria])
  @@index([activo])
}

// TABLA 9: MÉTODOS DE PAGO / MONEDEROS
model MetodoPago {
  id                    String   @id @default(cuid())
  nombre                String   // "Cuenta USD Bank of America", "Alipay Principal"
  tipo                  String   // "banco", "tarjeta", "monedero_digital"

  // Proveedor asociado (opcional)
  proveedorId           String?  @map("proveedor_id")

  // Información específica del método
  moneda                String   // "USD", "CNY", "EUR"

  // Datos bancarios (si es banco)
  banco                 String?
  numeroCuenta          String?  @map("numero_cuenta")
  titular               String?
  swift                 String?
  iban                  String?

  // Datos de tarjeta (si es tarjeta)
  ultimos4Digitos       String?  @map("ultimos_4_digitos")
  tipoTarjeta           String?  @map("tipo_tarjeta")  // "crédito", "débito"

  // Datos de monedero digital (si es Alipay, PayPal, etc)
  email                 String?  // Para PayPal
  telefono              String?  // Para Alipay/WeChat
  idCuenta              String?  @map("id_cuenta")  // ID genérico

  // Límites y comisiones
  limiteTransaccion     Decimal? @db.Decimal(12, 2) @map("limite_transaccion")
  comisionPorcentaje    Decimal? @db.Decimal(5, 2) @map("comision_porcentaje")
  comisionFija          Decimal? @db.Decimal(10, 2) @map("comision_fija")

  // Balance actual (opcional)
  balanceActual         Decimal? @db.Decimal(12, 2) @map("balance_actual")

  // Notas
  notas                 String?  @db.Text

  // Estado
  activo                Boolean  @default(true)

  // Relaciones
  proveedor             Proveedor? @relation(fields: [proveedorId], references: [id], onDelete: SetNull)

  // Timestamps
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@map("metodos_pago")
  @@index([proveedorId])
  @@index([tipo])
  @@index([moneda])
  @@index([activo])
}
